#!/usr/bin/env bash

echo "Posting comment on PR..."

# Use jq to properly escape the analysis results
ESCAPED_RESULTS=$(echo -e "${ANALYSIS_RESULTS}" | jq -sR .)

COMMENT_BODY=$(cat << EOF
# Code Analysis Report

${ANALYSIS_RESULTS}

---

[Approve](https://github.com/${REPO}/issues/${PR_NUMBER}/comments?body=/approve) | [Reject](https://github.com/${REPO}/issues/${PR_NUMBER}/comments?body=/reject)

*Generated by AI Code Analysis*
EOF
)

# Properly escape the entire comment body
ESCAPED_COMMENT=$(echo "$COMMENT_BODY" | jq -sR .)

# Post the comment
curl -X POST \
  -H "Authorization: Bearer ${GITHUB_TOKEN}" \
  -H "Accept: application/vnd.github.v3+json" \
  -d "{\"body\": ${ESCAPED_COMMENT}}" \
  "https://api.github.com/repos/${REPO}/issues/${PR_NUMBER}/comments"